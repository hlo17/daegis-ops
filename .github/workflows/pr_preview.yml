# .github/workflows/pr_preview.yml

name: PR Preview Diff

# ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãŒå®Ÿè¡Œã•ã‚Œã‚‹ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã‚’å®šç¾©
on:
  pull_request:
    types: [opened, synchronize] # PRãŒã‚ªãƒ¼ãƒ—ãƒ³ã¾ãŸã¯æ›´æ–°ã•ã‚ŒãŸæ™‚
    paths:
      - 'ops/runbooks/**.md'     # ops/runbooks/ å†…ã®MDãƒ•ã‚¡ã‚¤ãƒ«ãŒå¯¾è±¡

# ã“ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãŒPRã«ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ›¸ãè¾¼ã‚€æ¨©é™ã‚’è¨­å®š
permissions:
  pull-requests: write

jobs:
  generate-preview:
    runs-on: ubuntu-latest

    steps:
      # 1. PRã®ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      - name: Checkout repository
        uses: actions/checkout@v4
        # æ¯”è¼ƒå¯¾è±¡ã®ãƒ–ãƒ©ãƒ³ãƒ(main)ã®å±¥æ­´ã‚‚å–å¾—ã™ã‚‹ãŸã‚ã«fetch-depthã‚’0ã«è¨­å®š
        with:
          fetch-depth: 0

      # 2. å¤‰æ›´ã•ã‚ŒãŸMDãƒ•ã‚¡ã‚¤ãƒ«ã®ä¸€è¦§ã‚’å–å¾—
      - name: Get changed files
        id: changed-files
        run: |
          CHANGED_FILES=$(git diff --name-only ${{ github.event.before }} ${{ github.event.after }} -- 'ops/runbooks/**.md' | xargs)
          echo "files=$CHANGED_FILES" >> $GITHUB_OUTPUT

      # 3. å·®åˆ†ã‚’ç”Ÿæˆã—ã¦ã‚³ãƒ¡ãƒ³ãƒˆæœ¬æ–‡ã‚’ä½œæˆ
      - name: Generate diff content
        id: generate-diff
        run: |
          COMMENT_BODY="### ğŸ“ Runbook å¤‰æ›´ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼\n\n"
          if [ -z "${{ steps.changed-files.outputs.files }}" ]; then
            COMMENT_BODY+="å¤‰æ›´ã•ã‚ŒãŸRunbookã¯ã‚ã‚Šã¾ã›ã‚“ã€‚"
          else
            for file in ${{ steps.changed-files.outputs.files }}; do
              COMMENT_BODY+="#### \`$file\`\n\n"
              COMMENT_BODY+="\`\`\`diff\n"
              # git diff ã®å‡ºåŠ›ã‚’å¤‰æ•°ã«æ ¼ç´ã—ã€HEREDOCã®å±•é–‹ã‚’é˜²ã
              DIFF_CONTENT=$(git diff ${{ github.event.before }} ${{ github.event.after }} -- "$file")
              COMMENT_BODY+="$DIFF_CONTENT"
              COMMENT_BODY+="\n\`\`\`\n\n"
            done
          fi
          # è¤‡æ•°è¡Œã®BODYã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹ãŸã‚ã®ç‰¹æ®Šãªå½¢å¼
          echo 'body<<EOF' >> $GITHUB_OUTPUT
          echo "$COMMENT_BODY" >> $GITHUB_OUTPUT
          echo 'EOF' >> $GITHUB_OUTPUT

      # 4. PRã«ã‚³ãƒ¡ãƒ³ãƒˆã¨ã—ã¦æŠ•ç¨¿
      - name: Post preview comment
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `${{ steps.generate-diff.outputs.body }}`
            })
