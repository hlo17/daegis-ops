name: secret-grep
on: [push, pull_request]
jobs:
  scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }
      - name: Fail if Slack webhook pattern is found
        shell: bash
        run: |
          set -euo pipefail
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            RANGE="origin/${{ github.base_ref }}...HEAD"
          else
            RANGE="HEAD~50..HEAD"
          fi
          HIT=$(git rev-list --no-merges $RANGE \
            | xargs -r -n1 git show --pretty="" --name-only \
            | xargs -r grep -nE 'https://hooks\.slack\.com/' -- \
                . ':!venv/**' ':!**/venv/**' ':!**/site-packages/**' \
                ':!node_modules/**' ':!**/*.log' ':!**/*.bak*' ':!**/*.backup*' ':!**/*.env' \
                ':!ops/staging-snap/**' ':!ops/**/notifiers.bak/**' ':!ops/**/contact-points*.yaml' \
            || true)
          if [[ -n "$HIT" ]]; then
            echo "$HIT"
            echo "::error::Slack webhook-like string found"
            exit 1
          fi
          echo "OK"
