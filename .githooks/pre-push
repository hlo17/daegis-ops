#!/usr/bin/env bash
set -euo pipefail

RED=$'\e[31m'; YEL=$'\e[33m'; RST=$'\e[0m'

# upstream があれば @{u}..HEAD、無ければ origin/main..HEAD
if git rev-parse --abbrev-ref --symbolic-full-name @{u} >/dev/null 2>&1; then
  RANGE="@{u}..HEAD"
else
  RANGE="origin/main..HEAD"
fi

COMMITS=$(git rev-list --no-merges "$RANGE" 2>/dev/null || true)
[ -z "${COMMITS:-}" ] && exit 0

# BLOB を直接検索（作業ツリーは見ない）＋重いディレクトリは除外
if HIT=$(git grep -nE 'https://hooks\.slack\.com/' \
  $COMMITS -- \
  . \
  ':!venv/**' ':!**/venv/**' ':!**/site-packages/**' \
  ':!node_modules/**' ':!**/*.log' ':!**/*.bak*' ':!**/*.backup*' ':!**/*.env' \
  ':!ops/staging-snap/**' ':!ops/**/notifiers.bak/**' ':!ops/**/contact-points*.yaml' \
  || true); then
  if [[ -n "$HIT" ]]; then
    echo "$HIT" >&2
    echo "${RED}[pre-push] Slack Webhook らしき文字列を検出。push を中止します。${RST}" >&2
    echo "${YEL}対処: 対象コミットから機微情報を除去（revert / filter-repo / BFG）して再 push。${RST}" >&2
    echo "(一時的に無視するには: git push --no-verify) " >&2
    exit 1
  fi
fi
exit 0
