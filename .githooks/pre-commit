#!/usr/bin/env bash
set -euo pipefail
RED=$'\e[31m'; YEL=$'\e[33m'; RST=$'\e[0m'
ALLOW=".secrets-allowlist"

# ステージ済み差分から拾う
diff=$(git diff --cached -U0 || true)
hits=$(printf "%s" "$diff" | grep -E 'https://hooks\.slack\.com/' || true)

if [[ -n "$hits" ]]; then
  # allowlist で除外した残差を評価
  if [[ -f "$ALLOW" ]]; then
    remaining=$(printf "%s" "$hits" | grep -Ev -f "$ALLOW" || true)
  else
    remaining="$hits"
  fi

  if [[ -n "$remaining" ]]; then
    echo "${RED}[pre-commit] Slack Webhook らしき文字列を検出。コミットを中止します。${RST}" >&2
    echo "${YEL}対処: マスク/削除するか .env へ退避。テスト用は ${ALLOW} に追記で可。${RST}" >&2
    echo "(一時的に無視: git commit --no-verify)" >&2
    exit 1
  fi
fi
exit 0
